# セキュリティ修正テスト

このファイルは、今回修正した2つのセキュリティ問題をテストします。

---

## 修正した問題

### 問題2: 外部リンクのhref値エスケープ

**問題内容**:
- 外部リンクのhref値がエスケープされずにtitle属性に設定されていた
- 悪意のあるURLで属性インジェクション攻撃のリスクがあった

**修正内容**:
```javascript
// 修正前
node.setAttribute('title', '外部リンク: ' + href);

// 修正後
node.setAttribute('title', '外部リンク: ' + escapeHtml(href));
```

---

### 問題4: 重複ID生成対策

**問題内容**:
- 同じテキストの見出しが複数ある場合、同じIDが生成されていた
- リンクが正しくジャンプしない問題があった

**修正内容**:
- github-sluggerと同様に、重複時は連番を付与
- `概要` → `概要-1` → `概要-2` のように自動採番

---

## テスト1: 外部リンクのエスケープテスト

以下のリンクにマウスオーバーして、title属性を確認してください。

### 通常の外部リンク

[Googleへのリンク](https://www.google.com)

**期待される動作**:
- ✅ リンクにマウスオーバーすると、title属性に「外部リンク: https://www.google.com」と表示される
- ✅ 新しいタブで開く（target="_blank"）

### 特殊文字を含む外部リンク

[クエリパラメータ付きリンク](https://example.com?param=value&foo=bar)

[URLエンコード含むリンク](https://example.com/path?query=%E3%83%86%E3%82%B9%E3%83%88)

[アンカー付きリンク](https://example.com/page#section-1)

**期待される動作**:
- ✅ 特殊文字（&、=、#など）がHTMLエンティティにエスケープされている
- ✅ title属性が正しく表示される

### 悪意のあるURLパターン（ブロックされるべき）

[攻撃リンク1](https://evil.com/" onclick="alert('XSS'))

[攻撃リンク2](https://evil.com/' onmouseover='alert(1))

**期待される動作**:
- ✅ DOMPurifyが危険な部分を削除
- ✅ エスケープされたURLがtitle属性に表示される
- ✅ スクリプトは実行されない

---

## テスト2: 重複ID生成対策テスト

以下の見出しは同じテキストが複数回登場します。

### 概要

これは最初の「概要」セクションです。IDは `概要` になります。

### 概要

これは2回目の「概要」セクションです。IDは `概要-1` になります。

### 概要

これは3回目の「概要」セクションです。IDは `概要-2` になります。

---

### はじめに

最初の「はじめに」セクション。IDは `はじめに` になります。

### はじめに

2回目の「はじめに」セクション。IDは `はじめに-1` になります。

---

### 使用方法

最初の「使用方法」セクション。

### 使用方法

2回目の「使用方法」セクション。

### 使用方法

3回目の「使用方法」セクション。

### 使用方法

4回目の「使用方法」セクション。

---

## 確認方法

### 方法1: F12デベロッパーツールで確認

1. **F12キーを押してデベロッパーツールを開く**
2. **Elementsタブで見出しを確認**
   - 「概要」の見出しを3つ探す
   - それぞれのid属性を確認：`概要`、`概要-1`、`概要-2`

3. **外部リンクのtitle属性を確認**
   - Googleへのリンクの`<a>`タグを見る
   - title属性の値が正しくエスケープされているか確認

### 方法2: 目次リンクで確認

以下の手動目次から各セクションにジャンプできることを確認：

- [1回目の概要](#概要)
- [2回目の概要](#概要-1)
- [3回目の概要](#概要-2)
- [1回目のはじめに](#はじめに)
- [2回目のはじめに](#はじめに-1)

**期待される動作**:
- ✅ 各リンクをクリックすると、正しいセクションにジャンプする
- ✅ URLのフラグメント（#...）が変わる

### 方法3: マウスオーバーで確認

1. **外部リンクにマウスを乗せる**
2. **ツールチップ（title属性）が表示される**
3. **内容を確認**:
   - ✅ 「外部リンク: https://...」と表示される
   - ✅ 特殊文字がエスケープされている（`&amp;` など）

---

## 期待される結果まとめ

| テスト項目 | 期待される結果 |
|-----------|---------------|
| 重複見出しID | `概要`、`概要-1`、`概要-2`のように連番が付く |
| 重複見出しジャンプ | 手動目次から正しいセクションにジャンプできる |
| 外部リンクtitle | 「外部リンク: URL」が表示される |
| 特殊文字エスケープ | `&`が`&amp;`、`<`が`&lt;`になる |
| 新しいタブで開く | 外部リンクがtarget="_blank"で開く |
| スクリプト実行 | 悪意のあるURLでもスクリプトは実行されない |

---

## デバッグ情報

### 見出しIDの確認コマンド（Console）

```javascript
// すべての見出しのIDを確認
document.querySelectorAll('h1, h2, h3, h4, h5, h6').forEach((h, i) => {
  console.log(`${i}: ${h.tagName} "${h.textContent}" -> ID: "${h.id}"`);
});
```

### 外部リンクのtitle確認コマンド（Console）

```javascript
// すべての外部リンクのtitle属性を確認
document.querySelectorAll('a[href^="http"]').forEach((a, i) => {
  console.log(`${i}: href="${a.href}" title="${a.getAttribute('title')}"`);
});
```

---

## 修正前と修正後の比較

### 修正前の問題

**重複ID問題**:
```html
<h3 id="概要">概要</h3>
...
<h3 id="概要">概要</h3>  <!-- 重複！ -->
...
<h3 id="概要">概要</h3>  <!-- 重複！ -->
```
→ リンクが正しく機能しない

**エスケープ問題**:
```html
<a href="https://example.com?a=1&b=2"
   title="外部リンク: https://example.com?a=1&b=2">
```
→ `&`がエスケープされず、HTML構文エラーの可能性

### 修正後の動作

**重複ID対策**:
```html
<h3 id="概要">概要</h3>
...
<h3 id="概要-1">概要</h3>  <!-- 自動採番 -->
...
<h3 id="概要-2">概要</h3>  <!-- 自動採番 -->
```
→ すべてのIDが一意になり、リンクが正しく機能

**エスケープ対策**:
```html
<a href="https://example.com?a=1&b=2"
   title="外部リンク: https://example.com?a=1&amp;b=2">
```
→ `&`が`&amp;`にエスケープされ、安全
