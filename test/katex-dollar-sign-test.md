# KaTeX $記号 誤検知テスト

このファイルは、KaTeX数式レンダリングにおける$記号の誤検知を防ぐためのテストケースを含みます。

## markdown-it-katex公式ヒューリスティック

このプロジェクトでは、markdown-it-katexの公式ヒューリスティック（Pandoc標準）を使用して、$記号の誤検知を防いでいます：

### ルール

各`$`記号について、以下の条件で「開始可能（can_open）」と「終了可能（can_close）」を判定：

#### 開始デリミタ（can_open）
- **直前が空白/タブでない**（または文字列の先頭）
- **直後が空白/タブでない**

#### 終了デリミタ（can_close）
- **直前が空白/タブでない**
- **直後が数字でない**（または文字列の末尾）

#### コードブロック保護
- コードブロック（` ```...``` `）とインラインコード（`` `...` ``）内の`$`は保護される

### 実装方法
1. コードブロックを一時的にプレースホルダーに置換
2. 各`$`のcan_openとcan_closeを判定
3. can_openの`$`とcan_closeの`$`をペアにして`\(...\)`に変換
4. コードブロックを復元
5. KaTeX auto-renderでは`\(...\)`のみを有効化

### 参考実装
- [markdown-it-katex](https://github.com/waylonflinn/markdown-it-katex) - isValidDelim関数
- [micromark-extension-math](https://github.com/micromark/micromark-extension-math) - Pandoc準拠

## 1. 通常文章中の$記号（誤検知されるべきでないケース）

### 価格表示
- This product costs $100.
- I paid $50 for this book.
- The total is $1,234.56.
- 価格は$99です。

### スペースなし$記号（outerSpaceテスト）
- $100は高い
- I have $50
- The price is $30
- $variableという変数名

### 連続する$記号
- I have $10 and you have $20.
- $100 + $200 = $300

## 2. コードブロック内の$記号（誤検知されるべきでないケース）

### JavaScriptのテンプレートリテラル
```javascript
const message = `Hello, ${name}!`;
const price = `Total: $${amount}`;
const calculation = `Result: ${x + y}`;
```

### Bashスクリプト
```bash
echo "Price: $100"
PRICE=$100
export PATH=$PATH:/usr/local/bin
```

### jQuery
```javascript
$('#element').click(function() {
  $(this).addClass('active');
});
```

## 3. インラインコード内の$記号（誤検知されるべきでないケース）

- JavaScript変数： `${variable}`
- Bash変数： `$HOME`
- jQuery： `$('#id')`
- 価格： `$100`

## 4. 正しい数式表記（正しくレンダリングされるべきケース）

### インライン数式（$...$）
- スペースなし: $x=1$
- スペースなし: $y=2x+3$
- スペースなし: $\alpha + \beta = \gamma$

### スペースあり数式（outerSpaceテスト）
- スペースあり: $ x = 1 $
- スペースあり: $ y = 2x + 3 $
- スペースあり: $ \alpha + \beta = \gamma $

### ディスプレイ数式（$$...$$）
$$
E = mc^2
$$

$$
\frac{-b \pm \sqrt{b^2 - 4ac}}{2a}
$$

### LaTeX形式の数式
インライン: \(x^2 + y^2 = z^2\)

ディスプレイ:
\[
\sum_{i=1}^n i = \frac{n(n+1)}{2}
\]

## 5. エスケープされた$記号（そのまま表示されるべきケース）

- エスケープ: \$100
- エスケープ2つ: \$50 + \$30 = \$80

## 6. 複雑なケース

### 文章と数式の混在
The price is $100, but the equation $x = 100$ is different.

価格は$50で、数式は$y = 50$です。

### コードと数式の混在
JavaScriptコード `${variable}` と数式 $x + y = z$ は異なります。

## 7. HTMLタグを使った回避（GitHubスタイル）

- HTMLタグ: <span>$</span>100
- HTMLタグ2: <span>$</span>50 + <span>$</span>30

## 期待される結果

### ✅ 正しくレンダリングされるべき
- セクション4の**スペースなし**インライン数式（`$x=1$`など）
- セクション4のディスプレイ数式（`$$...$$`）
- LaTeX形式の数式（`\(...\)`と`\[...\]`）

### ❌ 数式としてレンダリングされるべきでない
- セクション1の価格表示（`$100`, `$10 and $20`など）
  - **理由**: 終了の`$`の直後が数字（ルール）
- セクション2のコードブロック内
  - **理由**: コードブロック保護処理
- セクション3のインラインコード内
  - **理由**: コードブロック保護処理
- セクション4の**スペースあり**数式（`$ x = 1 $`など）
  - **理由**: 開始/終了の`$`の前後に空白（ルール）
- セクション5のエスケープされた`$`記号
- セクション7のHTMLタグで囲まれた`$`記号
- **見出し（h1-h6）内の`$`記号**
  - **理由**: GitHubと同様、見出し内では数式を認識しない（追加テストケース参照）

### 🔍 markdown-it-katexヒューリスティック検証

#### 例1: `$ x = 1 $`
- 最初の`$`: can_open = false（直後が空白）
- 結果: ❌ 数式として認識されない

#### 例2: `$10 and $20`
- 位置0の`$`: can_open = true, can_close = false（直後が`1`=数字）
- 位置7の`$`（`and`の前の空白の後）: can_open = false（直前が空白）, can_close = false
- 結果: ❌ ペアが成立しないため数式として認識されない

#### 例3: `$50で、数式は$y = 50$です。`
- 位置0の`$`: can_open = true, can_close = false（直後が`5`=数字）
- 位置10の`$`（`は`の後）: can_open = true, can_close = true
- 位置18の`$`（`50`の後）: can_open = false（直前が`0`=数字？いや、直前は`0`だが空白でないのでOK）, can_close = true
- ペア: `$y = 50$` → ✅ 数式として認識される
- 結果: `$50`と`$y`が対にならず、`$y = 50$`のみが数式として認識される

#### 例4: `価格$100と数式$y=2$の違い`
- 位置2の`$`: can_open = true, can_close = false（直後が`1`=数字）
- 位置9の`$`: can_open = true, can_close = true
- 位置14の`$`: can_open = false（直前が`2`=数字？いや、直前は`2`だが判定は...）

待って、can_closeの条件を再確認：「直前が空白/タブでない」
- `2`は空白/タブでないので、直前の条件はOK
- 「直後が数字でない」をチェック
- 位置14の`$`の直後は`の`→ 数字でない → can_close = true

- ペア: `$y=2$` → ✅ 数式として認識される
- 結果: `$100`と`$y`が対にならず、`$y=2$`のみが数式として認識される

#### 例5: `$x=1$`
- 最初の`$`: can_open = true（直前なし、直後が`x`）
- 最後の`$`: can_close = true（直前が`1`、直後なし）
- 結果: ✅ 数式として認識される

## 追加テストケース

### エッジケース
- 単独の$記号: $
- 2つの$が離れている: $ と $
- 3つの$記号: $ $ $
- 空の数式: $$

### 日本語との組み合わせ
- これは$100です。
- $x=1$という式があります。
- 価格$100と数式$y=2$の違い

### 見出し内の$記号

#### テストケース1: 見出しに`$...$`というプレーンテキスト

##### この見出しには$...$というプレーンテキストが含まれる

**期待される結果**: 見出し内の`$...$`は数式として認識されず、そのまま表示される

#### テストケース2: 見出しに正しい数式

##### この見出しには$x=1$という数式が含まれる

**期待される結果**: 見出し内の`$x=1$`は数式として認識されず、そのまま`$x=1$`と表示される（GitHubの動作と同じ）

#### テストケース3: 通常の段落で`$...$`というプレーンテキスト

この段落では、インラインコードではなく通常のテキストで$...$という記述を使っています。

**期待される結果**:
- 段落内の`$...$`（バッククォートで囲まれている）→ インラインコードとして保護され、そのまま表示
- 段落内の$...$（バッククォートなし）→ can_openとcan_closeの条件を満たすため、数式として認識され、`...`が表示される

#### テストケース4: 通常の段落で正しい数式

この段落には$a=b+c$という数式が含まれています。

**期待される結果**: 段落内の`$a=b+c$`は数式として認識され、レンダリングされる
