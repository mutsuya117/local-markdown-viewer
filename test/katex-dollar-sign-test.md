# KaTeX $記号 誤検知テスト

このファイルは、KaTeX数式レンダリングにおける$記号の誤検知を防ぐためのテストケースを含みます。

## markdown-it-katex公式ヒューリスティック + GitHub拡張

このプロジェクトでは、markdown-it-katexの公式ヒューリスティック（Pandoc標準）にGitHubの追加ルールを組み合わせて、$記号の誤検知を防いでいます：

### ルール

各`$`記号について、以下の条件で「開始可能（can_open）」と「終了可能（can_close）」を判定：

#### 開始デリミタ（can_open）
- **直前が空白/タブでない**（または文字列の先頭）
- **直後が空白/タブでない**

#### 終了デリミタ（can_close）
- **直前が空白/タブでない**
- **直後が英数字でない**（または文字列の末尾）【GitHub拡張: 数字 → 英数字】

#### 内容の検証（GitHub拡張）
- **英数字（0-9, a-z, A-Z）が含まれている**
  - `$...$` → 英数字なし → ❌ 数式でない
  - `$abc$` → 英字あり → ✅ 数式
  - `$x=1$` → 英数字あり → ✅ 数式

#### その他の保護
- コードブロック（` ```...``` `）とインラインコード（`` `...` ``）内の`$`は保護される
- 見出し（h1-h6）内の`$`は数式として認識されない

### 実装方法
1. コードブロックを一時的にプレースホルダーに置換
2. 各`$`のcan_openとcan_closeを判定
3. can_openの`$`とcan_closeの`$`をペアにして`\(...\)`に変換
4. コードブロックを復元
5. KaTeX auto-renderでは`\(...\)`のみを有効化

### 参考実装
- [markdown-it-katex](https://github.com/waylonflinn/markdown-it-katex) - isValidDelim関数
- [micromark-extension-math](https://github.com/micromark/micromark-extension-math) - Pandoc準拠

## 1. 通常文章中の$記号（誤検知されるべきでないケース）

### 価格表示
- This product costs $100.
- I paid $50 for this book.
- The total is $1,234.56.
- 価格は$99です。

### スペースなし$記号（outerSpaceテスト）
- $100は高い
- I have $50
- The price is $30
- $variableという変数名

### 連続する$記号（価格表示パターン）

#### 基本パターン
- I have $10 and you have $20.
- $100 + $200 = $300
- between $10 and $20
- from $50 to $100

#### or/but/norなどの接続詞
- $10 or $20
- $30 but $40
- neither $15 nor $25

#### カンマ区切り
- $10, $20, $30
- Prices: $100, $200, $300, $400
- Choose from $5, $10, or $15

#### 範囲表記
- $10-$20 range
- $100～$200の範囲
- $50〜$100
- Price range: $30-$50

#### 日本語の接続詞
- $100で、$200で
- $50または$100
- $30から$40まで
- $10と$20の違い
- $100や$200など

#### 比較表現
- more than $100 but less than $200
- at least $50 or at most $75
- $100より高く$200より安い

#### 複雑な文章
- If you pay $10 and your friend pays $20, the total is $30.
- 価格は$100ですが、セール価格は$80です。
- The cost varies from $50 to $100 depending on the options.

## 2. コードブロック内の$記号（誤検知されるべきでないケース）

### JavaScriptのテンプレートリテラル
```javascript
const message = `Hello, ${name}!`;
const price = `Total: $${amount}`;
const calculation = `Result: ${x + y}`;
```

### Bashスクリプト
```bash
echo "Price: $100"
PRICE=$100
export PATH=$PATH:/usr/local/bin
```

### jQuery
```javascript
$('#element').click(function() {
  $(this).addClass('active');
});
```

## 3. インラインコード内の$記号（誤検知されるべきでないケース）

- JavaScript変数： `${variable}`
- Bash変数： `$HOME`
- jQuery： `$('#id')`
- 価格： `$100`

## 4. 正しい数式表記（正しくレンダリングされるべきケース）

### インライン数式（$...$）
- スペースなし: $x=1$
- スペースなし: $y=2x+3$
- スペースなし: $\alpha + \beta = \gamma$

### スペースあり数式（outerSpaceテスト）
- スペースあり: $ x = 1 $
- スペースあり: $ y = 2x + 3 $
- スペースあり: $ \alpha + \beta = \gamma $

### ディスプレイ数式（$$...$$）
$$
E = mc^2
$$

$$
\frac{-b \pm \sqrt{b^2 - 4ac}}{2a}
$$

### LaTeX形式の数式
インライン: \(x^2 + y^2 = z^2\)

ディスプレイ:
\[
\sum_{i=1}^n i = \frac{n(n+1)}{2}
\]

## 5. エスケープされた$記号（そのまま表示されるべきケース）

- エスケープ: \$100
- エスケープ2つ: \$50 + \$30 = \$80

## 6. 複雑なケース

### 文章と数式の混在
The price is $100, but the equation $x = 100$ is different.

価格は$50で、数式は$y = 50$です。

### コードと数式の混在
JavaScriptコード `${variable}` と数式 $x + y = z$ は異なります。

## 7. HTMLタグを使った回避（GitHubスタイル）

- HTMLタグ: <span>$</span>100
- HTMLタグ2: <span>$</span>50 + <span>$</span>30

## 期待される結果

### ✅ 正しくレンダリングされるべき
- セクション4の**スペースなし**インライン数式（`$x=1$`など）
  - **理由**: 内容に英数字が含まれる
- セクション4のディスプレイ数式（`$$...$$`）
- LaTeX形式の数式（`\(...\)`と`\[...\]`）
- 追加テストケース4の数式
  - `$a=b+c$` → **内容に英数字が含まれる**
  - `$\alpha$` → **内容に英数字が含まれる**（`alpha`という英字）
  - `$123$` → **内容に英数字が含まれる**
- **数式との混在**の数式部分
  - `$x=100$` → **内容に英数字が含まれる**
  - `$y=50$` → **内容に英数字が含まれる**
  - `$E=mc^2$` → **内容に英数字が含まれる**
  - `$a+b=20$` → **内容に英数字が含まれる**

### ❌ 数式としてレンダリングされるべきでない
- **セクション1の全ての価格表示パターン**
  - 基本パターン: `$100`, `$10 and $20`, `$100 + $200 = $300`
  - 接続詞: `$10 or $20`, `$30 but $40`
  - カンマ区切り: `$10, $20, $30`
  - 範囲表記: `$10-$20`, `$100～$200`
  - 日本語: `$100で、$200で`, `$50または$100`
  - 複雑な文章: すべて
  - **理由**: 終了の`$`の直後が英数字（ルール）
- **数式との混在**の価格部分: `$100`, `$50`, `$20`
  - **理由**: 終了の`$`の直後が英数字または記号
- セクション2のコードブロック内
  - **理由**: コードブロック保護処理
- セクション3のインラインコード内
  - **理由**: コードブロック保護処理
- セクション4の**スペースあり**数式（`$ x = 1 $`など）
  - **理由**: 開始/終了の`$`の前後に空白（ルール）
- セクション5のエスケープされた`$`記号
- セクション7のHTMLタグで囲まれた`$`記号
- **見出し（h1-h6）内の`$`記号**
  - **理由**: GitHubと同様、見出し内では数式を認識しない
- **エッジケースの記号のみのペア**: `$...$`, `$***$`, `$+++$`など
  - **理由**: 内容に英数字が含まれない（GitHub拡張ルール）

### 🔍 markdown-it-katexヒューリスティック検証

#### 例1: `$ x = 1 $`
- 最初の`$`: can_open = false（直後が空白）
- 結果: ❌ 数式として認識されない

#### 例2: `$10 and $20`
- 位置0の`$`: can_open = true, can_close = false（直後が`1`=英数字）
- 位置7の`$`（`and`の前の空白の後）: can_open = false（直前が空白）, can_close = false（直後が`2`=英数字）
- 結果: ❌ ペアが成立しないため数式として認識されない

#### 例3: `$50で、数式は$y = 50$です。`
- 位置0の`$`: can_open = true, can_close = false（直後が`5`=英数字）
- 位置10の`$`（`は`の後）: can_open = true, can_close = true
- 位置18の`$`（`50`の後）: can_open = false（直前が`0`=英数字）, can_close = true
- ペア候補: `$y = 50$`（位置10-18）
  - 内容: `y = 50` → 英数字を含む → ✅ 有効
- 結果: `$50`と`$y`が対にならず、`$y = 50$`のみが数式として認識される

#### 例4: `価格$100と数式$y=2$の違い`
- 位置2の`$`: can_open = true, can_close = false（直後が`1`=英数字）
- 位置9の`$`: can_open = true, can_close = true
- 位置14の`$`: can_open = false（直前が`2`=英数字）, can_close = true
- ペア候補: `$y=2$`（位置9-14）
  - 内容: `y=2` → 英数字を含む → ✅ 有効
- 結果: `$100`と`$y`が対にならず、`$y=2$`のみが数式として認識される

#### 例5: `$x=1$`
- 最初の`$`: can_open = true（直前なし、直後が`x`）
- 最後の`$`: can_close = true（直前が`1`、直後なし）
- ペア候補: `$x=1$`
  - 内容: `x=1` → 英数字を含む → ✅ 有効
- 結果: ✅ 数式として認識される

#### 例6: `$...$`（追加）
- 最初の`$`: can_open = true（直後が`.`）
- 最後の`$`: can_close = true（直前が`.`）
- ペア候補: `$...$`
  - 内容: `...` → 英数字を含まない → ❌ 無効
- 結果: ❌ 数式として認識されず、`$...$`がそのまま表示される

## 追加テストケース

### エッジケース

#### 単独・少数の$記号
- 単独の$記号: $
- 2つの$が離れている: $ と $
- 3つの$記号: $ $ $
- 4つ連続: $ $ $ $

#### 空白と$の組み合わせ
- 空白の直後: I paid $ 100
- 空白の直前: I paid 100 $
- 両側に空白: I paid $ 100 $

#### 特殊文字と$の組み合わせ
- カンマの後: Cost is $10, $20, $30
- ピリオドの後: First $10. Then $20. Finally $30.
- コロンの後: Total: $100
- セミコロンの後: Option A: $50; Option B: $75
- 括弧内: (cost: $100)
- 括弧と: ($10) and ($20)

#### 連続する数字と$
- 複数の価格: $10$20$30 (スペースなし)
- ドット区切り: $1.50 and $2.50
- カンマ区切りの大きな数: $1,000 and $2,000
- パーセント: $100 is 50% of $200

#### 記号のみのペア（英数字なし）
- $...$
- $***$
- $+++$
- $===$
- $---$
- $@@@$
- $###$

### 日本語との組み合わせ（価格表示）
- これは$100です。
- $x=1$という式があります。
- 価格$100と数式$y=2$の違い
- $100から$200まで
- $50または$80
- $10と$20と$30
- セール: $100が$80に！
- 通常価格$150、割引後$120

### 実世界の価格表示パターン
- Sale: was $100, now $80!
- Price dropped from $150 to $120
- Starting at $50, up to $200
- Budget: min $100, max $500
- Tier 1: $10/month, Tier 2: $20/month
- Small: $5, Medium: $10, Large: $15
- Original $99.99, Save $20, Now $79.99
- 定価$1,000→特価$800（$200お得！）

### 数式との混在（混乱しやすいケース）
- The price is $100, and the equation is $x=100$ (different meanings)
- 価格は$50で、数式は$y=50$です（意味が異なる）
- Cost: $100 vs Formula: $E=mc^2$ vs Variable: $\alpha$
- Paid $20 for item, calculated $a+b=20$ in math

### 見出し内の$記号

#### テストケース1: 見出しに`$...$`というプレーンテキスト

##### この見出しには$...$というプレーンテキストが含まれる

**期待される結果**: 見出し内の`$...$`は数式として認識されず、そのまま表示される

#### テストケース2: 見出しに正しい数式

##### この見出しには$x=1$という数式が含まれる

**期待される結果**: 見出し内の`$x=1$`は数式として認識されず、そのまま`$x=1$`と表示される（GitHubの動作と同じ）

### 段落内の内容検証テスト

#### テストケース3: 通常の段落で英数字を含まない`$...$`

この段落では、インラインコードではなく通常のテキストで$...$という記述を使っています。また、$@@@$や$###$のような記号だけのケースもテストします。

**期待される結果**:
- 段落内の`$...$`（バッククォート内）→ インラインコードとして保護され、そのまま表示
- 段落内の$...$（バッククォートなし）→ **内容に英数字が含まれない**ため、`$...$`がそのまま表示される
- 段落内の$@@@$（バッククォートなし）→ **内容に英数字が含まれない**ため、`$@@@$`がそのまま表示される
- 段落内の$###$（バッククォートなし）→ **内容に英数字が含まれない**ため、`$###$`がそのまま表示される

#### テストケース4: 通常の段落で英数字を含む数式

この段落には$a=b+c$という数式が含まれています。また、$\alpha$や$123$も含みます。

**期待される結果**:
- `$a=b+c$` → **内容に英数字が含まれる** → 数式としてレンダリング
- `$\alpha$` → **内容に英数字が含まれる**（`alpha`という英字） → 数式としてレンダリング
- `$123$` → **内容に英数字が含まれる** → 数式としてレンダリング

---

## リストと段落の比較テスト

### テストケース5: リスト内 vs 段落内の同じパターン

#### リスト内（上記のセクション1）
上記の「連続する$記号（価格表示パターン）」はすべてリスト形式（`- `）で記述されています。

#### 段落内（同じパターン）

以下は、同じパターンを通常の段落として記述したものです：

**基本パターン（段落）**: I have $10 and you have $20. また、$100 + $200 = $300 という計算や、between $10 and $20、from $50 to $100 という範囲表記もあります。

**接続詞（段落）**: Choose $10 or $20, or consider $30 but $40 as alternatives. Neither $15 nor $25 is available.

**カンマ区切り（段落）**: The options are $10, $20, $30 for basic plans. Prices: $100, $200, $300, $400 for premium. Choose from $5, $10, or $15.

**範囲表記（段落）**: The $10-$20 range is affordable. 価格は$100～$200の範囲です。Also $50〜$100 or price range: $30-$50.

**日本語接続詞（段落）**: 価格は$100で、$200でも購入できます。$50または$100、$30から$40まで選べます。$10と$20の違いは大きい。$100や$200などがあります。

**比較表現（段落）**: It costs more than $100 but less than $200. You need at least $50 or at most $75. これは$100より高く$200より安いです。

**実世界パターン（段落）**: Sale: was $100, now $80! Price dropped from $150 to $120. Starting at $50, up to $200. Budget: min $100, max $500. Tier 1: $10/month, Tier 2: $20/month. Choose: Small: $5, Medium: $10, Large: $15. Get it now: Original $99.99, Save $20, Now $79.99. 定価$1,000→特価$800（$200お得！）

**数式との混在（段落）**: The price is $100, and the equation is $x=100$ (different meanings). 価格は$50で、数式は$y=50$です（意味が異なる）。Compare: Cost: $100 vs Formula: $E=mc^2$ vs Variable: $\alpha$. Paid $20 for item, calculated $a+b=20$ in math.

**期待される結果**: リスト内と段落内で**同じ動作**になるべき
- 価格表示（`$10 and $20`など）→ そのまま表示
- 数式（`$x=100$`, `$E=mc^2$`など）→ レンダリング

### テストケース6: 見出し vs リスト vs 段落の3者比較

同じパターン「I have $10 and you have $20.」を3つの異なるコンテキストでテスト：

#### パターンA: 見出しの場合

##### I have $10 and you have $20.

**期待**: `$10`と`$20`がそのまま表示される（見出し内は数式を認識しない）

#### パターンB: リストの場合

- I have $10 and you have $20.

**期待**: `$10`と`$20`がそのまま表示される（終了`$`の直後が英数字）

#### パターンC: 段落の場合

I have $10 and you have $20.

**期待**: `$10`と`$20`がそのまま表示される（終了`$`の直後が英数字）

---

### テストケース7: 数式パターンの3者比較

同じ数式「$x=1$」を3つの異なるコンテキストでテスト：

#### パターンA: 見出しの場合

##### 数式は$x=1$です

**期待**: `$x=1$`がそのまま表示される（見出し内は数式を認識しない）

#### パターンB: リストの場合

- 数式は$x=1$です

**期待**: `$x=1$`が数式としてレンダリングされる（内容に英数字を含む）

#### パターンC: 段落の場合

数式は$x=1$です。

**期待**: `$x=1$`が数式としてレンダリングされる（内容に英数字を含む）

---

### テストケース8: 引用ブロック内のテスト

> I have $10 and you have $20.
>
> 数式は$x=1$です。
>
> Price range: $100～$200の範囲

**期待される結果**: 引用ブロック内でも通常の段落と同じ動作
- `$10`と`$20` → そのまま表示
- `$x=1$` → 数式としてレンダリング
- `$100`と`$200` → そのまま表示

---

### テストケース9: テーブル内のテスト

| 項目 | 価格 | 数式 |
|------|------|------|
| Item A | $100 | $x=1$ |
| Item B | $50 and $80 | $y=2x+3$ |
| Range | $10-$20 | $\alpha + \beta$ |

**期待される結果**: テーブル内でも通常の段落と同じ動作
- 価格列: `$100`, `$50 and $80`, `$10-$20` → そのまま表示
- 数式列: `$x=1$`, `$y=2x+3$`, `$\alpha + \beta$` → 数式としてレンダリング

---

### テストケース10: ネストしたリスト内のテスト

- レベル1: Price is $100
  - レベル2: Range is $50 to $80
    - レベル3: Formula is $x=1$
  - レベル2: Alternative $30 or $40
- レベル1: Equation $y=2x+3$ is valid

**期待される結果**: ネストの深さに関わらず同じ動作
- 価格表示: `$100`, `$50 to $80`, `$30 or $40` → そのまま表示
- 数式: `$x=1$`, `$y=2x+3$` → レンダリング

---

### テストケース11: 番号付きリスト内のテスト

1. First option costs $100
2. Second option is $50 to $80
3. Formula: $a=b+c$
4. Discounted from $200 to $150

**期待される結果**: 番号付きリストでも同じ動作
- 価格表示: `$100`, `$50 to $80`, `$200 to $150` → そのまま表示
- 数式: `$a=b+c$` → レンダリング

## テストパターンサマリー

このファイルには、以下のカテゴリのテストケースが含まれています：

### 1. 価格表示パターン（約80+ケース）
- **リスト形式**: 約40ケース
- **段落形式**: 約40ケース（同じパターン）
- 基本的な価格表示、接続詞、範囲表記、カンマ区切り、日本語、実世界のパターン

### 2. コンテキスト別テスト（約20+ケース）
- **見出し内**: 数式を認識しない（テストケース1, 2, 6, 7）
- **リスト内**: 通常のルール適用（テストケース5, 6, 7, 10, 11）
- **段落内**: 通常のルール適用（テストケース3, 4, 5, 6, 7）
- **引用ブロック内**: 通常のルール適用（テストケース8）
- **テーブル内**: 通常のルール適用（テストケース9）
- **ネストしたリスト**: 深さに関わらず同じ動作（テストケース10）
- **番号付きリスト**: 同じ動作（テストケース11）

### 3. コードとの組み合わせ
- コードブロック内（JavaScript, Bash, jQuery）
- インラインコード内

### 4. 正しい数式表記
- インライン数式: `$x=1$`, `$\alpha$`, `$E=mc^2$`
- ディスプレイ数式: `$$E=mc^2$$`
- LaTeX形式: `\(x^2\)`, `\[...\]`

### 5. エッジケース（約30+ケース）
- 空白パターン: `$ x $`, `$ 100`
- 特殊文字パターン: `$...$`, `$***$`
- 単独・少数の$記号
- 記号のみのペア（英数字なし）
- 数式と価格の混在

**合計テストケース数**: 約140+パターン

---

## 検証のポイント

このテストファイルで検証できる項目：

1. ✅ **終了`$`の直後が英数字** → 価格表示として認識
2. ✅ **内容に英数字が含まれない** → 数式として認識しない
3. ✅ **見出し内** → 数式として認識しない
4. ✅ **コードブロック/インラインコード内** → 保護される
5. ✅ **リスト vs 段落 vs 引用 vs テーブル** → すべて同じルールが適用される
6. ✅ **数式と価格の混在** → 正しく区別される
