# KaTeX $記号 誤検知テスト

このファイルは、KaTeX数式レンダリングにおける$記号の誤検知を防ぐためのテストケースを含みます。

---

## パート1: 式として表示される内容があるパターン

このパートでは、一部またはすべての数式記法が数式としてレンダリングされます。

### 基本的な数式（$...$形式）

#### リスト
- $x=1$
- $y=2x+3$
- $\alpha + \beta = \gamma$
- $E=mc^2$
- $a+b=c$
- $\frac{1}{2}$
- $\sum_{i=1}^n i$
- $\int_0^1 x dx$

#### 段落
これらの数式は段落内でもレンダリングされます: $x=1$, $y=2x+3$, $\alpha + \beta = \gamma$, $E=mc^2$

#### 引用ブロック
> 数式は$x=1$です。

#### テーブル
| 項目 | 数式 |
|------|------|
| Item A | $x=1$ |
| Item B | $y=2x+3$ |

#### ネストしたリスト
- レベル1: Formula is $x=1$
  - レベル2: Equation $y=2x+3$ is valid

#### 番号付きリスト
1. Formula: $a=b+c$

### ディスプレイ数式（$$...$$形式）
$$
E = mc^2
$$

$$
\frac{-b \pm \sqrt{b^2 - 4ac}}{2a}
$$

### LaTeX形式（このプロジェクトの追加機能）

#### インライン（\(...\)形式）
- \(x^2 + y^2 = z^2\)
- \(\alpha + \beta = \gamma\)
- \(\frac{a}{b}\)

#### ディスプレイ（\[...\]形式）
\[
\sum_{i=1}^n i = \frac{n(n+1)}{2}
\]

\[
\int_0^1 x^2 dx
\]

### 数式と価格の混在（重要テスト）

これらでは、数式部分のみがレンダリングされ、価格部分はそのまま表示されます。

#### リスト
- The price is $100, but the equation $x=100$ is different.
- 価格は$50で、数式は$y=50$です。
- Cost: $100 vs Formula: $E=mc^2$ vs Variable: $\alpha$
- Paid $20 for item, calculated $a+b=20$ in math

#### 段落
The price is $100, but the equation $x = 100$ is different. 価格は$50で、数式は$y = 50$です（意味が異なる）。Compare: Cost: $100 vs Formula: $E=mc^2$ vs Variable: $\alpha$. Paid $20 for item, calculated $a+b=20$ in math.

**期待される結果**:
- 価格: `$100`, `$50`, `$20` → そのまま表示
- 数式: `$x=100$`, `$y=50$`, `$E=mc^2$`, `$\alpha$`, `$a+b=20$` → レンダリング

---

## パート2: すべて式として出るべきではないパターン

このパートでは、すべての`$`記号がそのまま表示されます（数式として認識されない）。

### 価格表示（基本）
- This product costs $100.
- I paid $50 for this book.
- The total is $1,234.56.
- 価格は$99です。
- $100は高い
- I have $50
- The price is $30

### 連続する$記号（価格表示 - 接続詞）

#### リスト
- I have $10 and you have $20.
- $100 + $200 = $300
- between $10 and $20
- from $50 to $100
- $10 or $20
- $30 but $40
- neither $15 nor $25

#### 段落
I have $10 and you have $20. また、$100 + $200 = $300 という計算や、between $10 and $20、from $50 to $100 という範囲表記もあります。Choose $10 or $20, or consider $30 but $40 as alternatives. Neither $15 nor $25 is available.

### 連続する$記号（カンマ区切り）

#### リスト
- $10, $20, $30
- Prices: $100, $200, $300, $400
- Choose from $5, $10, or $15

#### 段落
The options are $10, $20, $30 for basic plans. Prices: $100, $200, $300, $400 for premium. Choose from $5, $10, or $15.

### 連続する$記号（範囲表記）

#### リスト
- $10-$20 range
- $100～$200の範囲
- $50〜$100
- Price range: $30-$50

#### 段落
The $10-$20 range is affordable. 価格は$100～$200の範囲です。Also $50〜$100 or price range: $30-$50.

### 連続する$記号（日本語の接続詞）

#### リスト
- $100で、$200で
- $50または$100
- $30から$40まで
- $10と$20の違い
- $100や$200など
- これは$100です。
- 価格$100と数式$y=2$の違い
- $100から$200まで
- $50または$80
- $10と$20と$30
- セール: $100が$80に！
- 通常価格$150、割引後$120

#### 段落
価格は$100で、$200でも購入できます。$50または$100、$30から$40まで選べます。$10と$20の違いは大きい。$100や$200などがあります。

### 連続する$記号（比較表現）

#### リスト
- more than $100 but less than $200
- at least $50 or at most $75
- $100より高く$200より安い

#### 段落
It costs more than $100 but less than $200. You need at least $50 or at most $75. これは$100より高く$200より安いです。

### 連続する$記号（実世界のパターン）

#### リスト
- Sale: was $100, now $80!
- Price dropped from $150 to $120
- Starting at $50, up to $200
- Budget: min $100, max $500
- Tier 1: $10/month, Tier 2: $20/month
- Small: $5, Medium: $10, Large: $15
- Original $99.99, Save $20, Now $79.99
- 定価$1,000→特価$800（$200お得！）

#### 段落
Sale: was $100, now $80! Price dropped from $150 to $120. Starting at $50, up to $200. Budget: min $100, max $500. Tier 1: $10/month, Tier 2: $20/month. Choose: Small: $5, Medium: $10, Large: $15. Get it now: Original $99.99, Save $20, Now $79.99. 定価$1,000→特価$800（$200お得！）

### コードブロック内
```javascript
const message = `Hello, ${name}!`;
const price = `Total: $${amount}`;
const calculation = `Result: ${x + y}`;
```

```bash
echo "Price: $100"
PRICE=$100
export PATH=$PATH:/usr/local/bin
```

```javascript
$('#element').click(function() {
  $(this).addClass('active');
});
```

### インラインコード内
- JavaScript変数： `${variable}`
- Bash変数： `$HOME`
- jQuery： `$('#id')`
- 価格： `$100`

### スペースありパターン（$の前後に空白）
- $ x = 1 $
- $ y = 2x + 3 $
- $ \alpha + \beta = \gamma $

### エスケープ（バックスラッシュでエスケープ）
- \$100
- \$50 + \$30 = \$80

### HTMLタグ回避
- <span>$</span>100
- <span>$</span>50 + <span>$</span>30

### エッジケース（空白パターン）
- I paid $ 100
- I paid 100 $
- I paid $ 100 $

### エッジケース（特殊文字）
- Cost is $10, $20, $30
- First $10. Then $20. Finally $30.
- Total: $100
- Option A: $50; Option B: $75
- (cost: $100)
- ($10) and ($20)

### エッジケース（連続する$）
- $10$20$30
- $1.50 and $2.50
- $1,000 and $2,000
- $100 is 50% of $200

### エッジケース（単独・少数の$）
- 単独: $
- 2つ: $ と $
- 3つ: $ $ $
- 4つ: $ $ $ $

### エッジケース（記号のみのペア - 英数字なし）

#### インライン（$...$形式）
- $...$
- $***$
- $+++$
- $===$
- $---$
- $@@@$
- $###$

#### ディスプレイ（$$...$$形式）
$$
...
$$

$$
***
$$

$$
+++
$$

#### LaTeX形式（\(...\)と\[...\]）
- \(...\)
- \(***\)
- \(+++\)

\[
...
\]

\[
***
\]

### 文章中の数式記法（英数字なし）
- ディスプレイ数式（$$...$$と\[...\]形式）が正しく表示される

**期待**: `$$...$$`と`\[...\]`の部分は両方とも英数字を含まないため、そのまま表示される

### 見出し内（すべての数式記法が無効）

以下の見出しでは、数式記法がすべてそのまま表示されます：

##### この見出しには$...$というプレーンテキストが含まれる
##### この見出しには$x=1$という数式が含まれる
##### この見出しには$$...$$という記法が含まれる
##### この見出しには\[...\]という記法が含まれる
##### この見出しには\(x=1\)という記法が含まれる
##### I have $10 and you have $20.
##### 数式は$x=1$です

### コンテキスト別（価格表示のみ）

#### 引用ブロック
> I have $10 and you have $20.
> Price range: $100～$200の範囲

#### テーブル
| 項目 | 価格 |
|------|------|
| Item A | $100 |
| Item B | $50 and $80 |
| Range | $10-$20 |

#### ネストしたリスト
- レベル1: Price is $100
  - レベル2: Range is $50 to $80
    - レベル3: Alternative $30 or $40

#### 番号付きリスト
1. First option costs $100
2. Second option is $50 to $80
3. Discounted from $200 to $150

---

## パート3: GitHub互換ヒューリスティックの説明

### サポートする数式記法
- ✅ インライン数式: `$...$`（GitHub互換ヒューリスティック）
- ✅ ディスプレイ数式: `$$...$$`（GitHub互換 + 英数字チェック）
- ✅ LaTeX形式: `\(...\)`と`\[...\]`（GitHub以上の機能 + 英数字チェック）

### ルール

#### $...$のルール（can_openとcan_close）

**開始デリミタ（can_open）**:
- 直後が空白/タブでない

**終了デリミタ（can_close）**:
- 直前が空白/タブでない
- 直後が英数字でない

**ペアリング**:
- 隣接する`$`同士のみをペアにする

#### すべての数式記法に共通のルール

**内容の検証（英数字チェック）**:
- 英数字（0-9, a-z, A-Z）が含まれている
- 適用対象: `$...$`, `$$...$$`, `\[...\]`, `\(...\)`すべて

**保護される場所**:
- コードブロック（` ```...``` `）内
- インラインコード（`` `...` ``）内
- 見出し（h1-h6）内

### 検証例

#### 例1: `$x=1$` ✅
- 隣接する`$`のペア → ✅
- 内容`x=1` → 英数字あり → ✅
- **結果**: 数式としてレンダリング

#### 例2: `$10 and $20` ❌
- `$10`の終了`$`: 直後が空白 → can_close = false
- ペア不成立 → ❌
- **結果**: そのまま表示

#### 例3: `$100, but $x=100$` 一部✅
- `$100`と`,`の間: 終了`$`の直後が`,`(英数字でない) → can_close = true
- しかし`$100`と` $x`は**隣接していない**
- `$x=100$`は隣接ペア → ✅
- **結果**: `$100`そのまま、`$x=100$`のみレンダリング

#### 例4: `$...$` ❌
- 隣接する`$`のペア → ✅
- 内容`...` → 英数字なし → ❌
- **結果**: そのまま表示

#### 例5: `$ x = 1 $` ❌
- 開始`$`の直後が空白 → can_open = false
- **結果**: そのまま表示

#### 例6: `$$E=mc^2$$` ✅
- 内容`E=mc^2` → 英数字あり → ✅
- **結果**: 数式としてレンダリング

#### 例7: `$$...$$` ❌
- 内容`...` → 英数字なし → ❌
- **結果**: そのまま表示

#### 例8: `\[\sum_{i=1}^n i\]` ✅
- 内容`\sum_{i=1}^n i` → 英数字あり → ✅
- **結果**: 数式としてレンダリング

#### 例9: `\[...\]` ❌
- 内容`...` → 英数字なし → ❌
- **結果**: そのまま表示

#### 例10: `\(x^2\)` ✅
- 内容`x^2` → 英数字あり → ✅
- **結果**: 数式としてレンダリング

#### 例11: `\(...\)` ❌
- 内容`...` → 英数字なし → ❌
- **結果**: そのまま表示

### 実装方法
1. コードブロック、インラインコード、見出し行を一時保護
2. **英数字チェック**:
   - `$$...$$`: 英数字あり → 保護、英数字なし → 無効化プレースホルダー
   - `\[...\]`: 英数字あり → 保護、英数字なし → 無効化プレースホルダー
   - `\(...\)`: 英数字あり → 保護、英数字なし → 無効化プレースホルダー
3. コードブロックと見出し行を復元
4. Marked.jsでMarkdown → HTML変換
5. DOMPurifyでサニタイズ
6. 保護したプレースホルダーを元に戻す（無効化分はゼロ幅スペース挿入）
7. HTMLレンダリング後、各`$`のcan_openとcan_closeを判定
8. 隣接する`$`でペアを作成し、**英数字チェック後**に`\(...\)`に変換
9. KaTeX auto-renderで処理

### 参考実装
- [markdown-it-katex](https://github.com/waylonflinn/markdown-it-katex) - isValidDelim関数
- [micromark-extension-math](https://github.com/micromark/micromark-extension-math)
- 実際のGitHubの動作に基づく調整

---

## パート4: テストパターンサマリー

### パート1の内容（約45パターン）
- 基本的な数式: `$...$`形式（リスト、段落、引用、テーブル、ネストリスト、番号付きリスト）
- ディスプレイ数式: `$$...$$`形式（英数字あり）
- LaTeX形式: `\(...\)`と`\[...\]`（英数字あり - GitHub以上の機能）
- 数式と価格の混在（数式部分のみレンダリング）

### パート2の内容（約100パターン）
- 価格表示（約80ケース）:
  - 基本、接続詞、カンマ区切り、範囲表記、日本語、比較表現、実世界のパターン
  - リスト形式と段落形式の両方
- コードブロック・インラインコード内（約5ケース）
- スペースあり、エスケープ、HTMLタグ（約5ケース）
- エッジケース（約15ケース）:
  - 空白パターン、特殊文字、連続する$、単独・少数の$、記号のみのペア
- 数式記法（英数字なし）（約5ケース）:
  - `$...$`, `$$...$$`, `\[...\]`, `\(...\)`
- 見出し内（約7ケース）
- 各コンテキストの価格（約5ケース）

**合計: 約145+パターン**

### 検証できる項目
1. ✅ **終了`$`の直後が英数字** → 価格表示として認識
2. ✅ **内容に英数字が含まれない** → 数式として認識しない（すべての数式記法に適用）
3. ✅ **見出し内** → すべての数式記法が無効
4. ✅ **コードブロック/インラインコード内** → 保護される
5. ✅ **隣接ペアリング** → 正しく区別（`$100, but $x=100$` → `$x=100$`のみ数式）
6. ✅ **リスト・段落・引用・テーブル** → すべて同じ動作
7. ✅ **統一された英数字チェック** → `$...$`, `$$...$$`, `\[...\]`, `\(...\)`すべてに適用
