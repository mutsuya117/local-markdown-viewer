# KaTeX $記号 誤検知テスト

このファイルは、KaTeX数式レンダリングにおける$記号の誤検知を防ぐためのテストケースを含みます。

---

## パート1: 式として表示される内容があるパターン

以下のパターンでは、一部またはすべての`$...$`が数式としてレンダリングされます。

### 基本的な数式（リスト）
- $x=1$
- $y=2x+3$
- $\alpha + \beta = \gamma$
- $E=mc^2$
- $a+b=c$
- $\frac{1}{2}$
- $\sum_{i=1}^n i$
- $\int_0^1 x dx$

### 基本的な数式（段落）
これらの数式は段落内でもレンダリングされます: $x=1$, $y=2x+3$, $\alpha + \beta = \gamma$, $E=mc^2$

### ディスプレイ数式
$$
E = mc^2
$$

$$
\frac{-b \pm \sqrt{b^2 - 4ac}}{2a}
$$

### LaTeX形式
- インライン: \(x^2 + y^2 = z^2\)
- ディスプレイ: \[\sum_{i=1}^n i = \frac{n(n+1)}{2}\]

### 数式と価格の混在（重要）

#### リスト
- The price is $100, but the equation $x=100$ is different.
- 価格は$50で、数式は$y=50$です。
- Cost: $100 vs Formula: $E=mc^2$ vs Variable: $\alpha$
- Paid $20 for item, calculated $a+b=20$ in math

#### 段落
The price is $100, but the equation $x = 100$ is different. 価格は$50で、数式は$y = 50$です（意味が異なる）。Compare: Cost: $100 vs Formula: $E=mc^2$ vs Variable: $\alpha$. Paid $20 for item, calculated $a+b=20$ in math.

**期待**: 価格（`$100`, `$50`, `$20`）はそのまま表示、数式（`$x=100$`, `$y=50$`など）のみレンダリング

### コンテキスト別（数式）

#### リスト
- 数式は$x=1$です
- Formula: $a=b+c$
- Equation $y=2x+3$ is valid

#### 段落
数式は$x=1$です。この段落には$a=b+c$という数式が含まれています。また、$\alpha$や$123$も含みます。

#### 引用ブロック
> 数式は$x=1$です。

#### テーブル
| 項目 | 数式 |
|------|------|
| Item A | $x=1$ |
| Item B | $y=2x+3$ |

#### ネストしたリスト
- レベル1: Formula is $x=1$
  - レベル2: Equation $y=2x+3$ is valid

#### 番号付きリスト
1. Formula: $a=b+c$

---

## パート2: すべて式として出るべきではないパターン

以下のパターンでは、すべての`$`記号がそのまま表示されます（数式として認識されない）。

### 価格表示（基本）
- This product costs $100.
- I paid $50 for this book.
- The total is $1,234.56.
- 価格は$99です。
- $100は高い
- I have $50
- The price is $30

### 連続する$記号（価格表示）

#### 接続詞パターン（リスト）
- I have $10 and you have $20.
- $100 + $200 = $300
- between $10 and $20
- from $50 to $100
- $10 or $20
- $30 but $40
- neither $15 nor $25

#### 接続詞パターン（段落）
I have $10 and you have $20. また、$100 + $200 = $300 という計算や、between $10 and $20、from $50 to $100 という範囲表記もあります。Choose $10 or $20, or consider $30 but $40 as alternatives. Neither $15 nor $25 is available.

#### カンマ区切り（リスト）
- $10, $20, $30
- Prices: $100, $200, $300, $400
- Choose from $5, $10, or $15

#### カンマ区切り（段落）
The options are $10, $20, $30 for basic plans. Prices: $100, $200, $300, $400 for premium.

#### 範囲表記（リスト）
- $10-$20 range
- $100～$200の範囲
- $50〜$100
- Price range: $30-$50

#### 範囲表記（段落）
The $10-$20 range is affordable. 価格は$100～$200の範囲です。Also $50〜$100 or price range: $30-$50.

#### 日本語の接続詞（リスト）
- $100で、$200で
- $50または$100
- $30から$40まで
- $10と$20の違い
- $100や$200など

#### 日本語の接続詞（段落）
価格は$100で、$200でも購入できます。$50または$100、$30から$40まで選べます。$10と$20の違いは大きい。$100や$200などがあります。

#### 比較表現（リスト）
- more than $100 but less than $200
- at least $50 or at most $75
- $100より高く$200より安い

#### 比較表現（段落）
It costs more than $100 but less than $200. You need at least $50 or at most $75. これは$100より高く$200より安いです。

#### 実世界のパターン（リスト）
- Sale: was $100, now $80!
- Price dropped from $150 to $120
- Starting at $50, up to $200
- Budget: min $100, max $500
- Tier 1: $10/month, Tier 2: $20/month
- Small: $5, Medium: $10, Large: $15
- Original $99.99, Save $20, Now $79.99
- 定価$1,000→特価$800（$200お得！）

#### 実世界のパターン（段落）
Sale: was $100, now $80! Price dropped from $150 to $120. Starting at $50, up to $200. Budget: min $100, max $500. Tier 1: $10/month, Tier 2: $20/month. Choose: Small: $5, Medium: $10, Large: $15. Get it now: Original $99.99, Save $20, Now $79.99. 定価$1,000→特価$800（$200お得！）

### コードブロック内
```javascript
const message = `Hello, ${name}!`;
const price = `Total: $${amount}`;
const calculation = `Result: ${x + y}`;
```

```bash
echo "Price: $100"
PRICE=$100
export PATH=$PATH:/usr/local/bin
```

```javascript
$('#element').click(function() {
  $(this).addClass('active');
});
```

### インラインコード内
- JavaScript変数： `${variable}`
- Bash変数： `$HOME`
- jQuery： `$('#id')`
- 価格： `$100`

### スペースありパターン
- $ x = 1 $
- $ y = 2x + 3 $
- $ \alpha + \beta = \gamma $

### エスケープ
- \$100
- \$50 + \$30 = \$80

### HTMLタグ回避
- <span>$</span>100
- <span>$</span>50 + <span>$</span>30

### エッジケース（空白）
- I paid $ 100
- I paid 100 $
- I paid $ 100 $

### エッジケース（特殊文字）
- Cost is $10, $20, $30
- First $10. Then $20. Finally $30.
- Total: $100
- Option A: $50; Option B: $75
- (cost: $100)
- ($10) and ($20)

### エッジケース（連続）
- $10$20$30
- $1.50 and $2.50
- $1,000 and $2,000
- $100 is 50% of $200

### エッジケース（記号のみ - 英数字なし）
- $...$
- $***$
- $+++$
- $===$
- $---$
- $@@@$
- $###$
- 単独: $
- 2つ: $ と $
- 3つ: $ $ $

### ディスプレイ数式（記号のみ - 英数字なし）
$$
...
$$

$$
***
$$

$$
+++
$$

**期待**: これらは内容に英数字が含まれないため、`$$...$$`がそのまま表示される

### LaTeX形式（記号のみ - 英数字なし）
\[
...
\]

\[
***
\]

**期待**: これらは内容に英数字が含まれないため、`\[...\]`がそのまま表示される

### 見出し内（すべての数式記法が無効）

##### この見出しには$...$というプレーンテキストが含まれる
##### この見出しには$x=1$という数式が含まれる
##### この見出しには$$...$$という記法が含まれる
##### この見出しには\[...\]という記法が含まれる
##### この見出しには\(x=1\)という記法が含まれる
##### I have $10 and you have $20.
##### 数式は$x=1$です

### コンテキスト別（価格）

#### 引用ブロック
> I have $10 and you have $20.
> Price range: $100～$200の範囲

#### テーブル
| 項目 | 価格 |
|------|------|
| Item A | $100 |
| Item B | $50 and $80 |
| Range | $10-$20 |

#### ネストしたリスト
- レベル1: Price is $100
  - レベル2: Range is $50 to $80
    - レベル3: Alternative $30 or $40

#### 番号付きリスト
1. First option costs $100
2. Second option is $50 to $80
3. Discounted from $200 to $150

---

## パート3: GitHub互換ヒューリスティックの説明

### ルール

#### 開始デリミタ（can_open）
- **直後が空白/タブでない**
- （注: 直前のチェックなし）

#### 終了デリミタ（can_close）
- **直前が空白/タブでない**
- **直後が英数字でない**

#### 内容の検証（すべての数式記法に適用）
- **英数字（0-9, a-z, A-Z）が含まれている**
  - インライン数式:
    - `$...$` → 英数字なし → ❌
    - `$abc$` → 英字あり → ✅
    - `$x=1$` → 英数字あり → ✅
  - ディスプレイ数式:
    - `$$...$$` → 英数字なし → ❌
    - `$$E=mc^2$$` → 英数字あり → ✅
  - LaTeX形式:
    - `\[...\]` → 英数字なし → ❌
    - `\[\sum_{i=1}^n\]` → 英数字あり → ✅

#### ペアリング
- **隣接する`$`同士のみをペア**にする
- 例: `$100, but $x=100$` → `$x=100$`のみがペア（`$100`と`100$`はペアにならない）

#### その他の保護
- コードブロック・インラインコード内は保護
- 見出し（h1-h6）内はすべての数式記法が無効

### 実装方法
1. コードブロック、インラインコード、見出し行を一時保護
2. `$$...$$`と`\[...\]`を**内容に英数字が含まれる場合のみ**保護
3. コードブロックと見出し行を復元
4. HTMLレンダリング後、各`$`のcan_openとcan_closeを判定
5. 隣接する`$`でペアを作成し、**内容に英数字が含まれる場合のみ**`\(...\)`に変換
6. KaTeX auto-renderで処理（`$$`, `\[...\]`, `\(...\)`）

### 参考実装
- [markdown-it-katex](https://github.com/waylonflinn/markdown-it-katex)
- [micromark-extension-math](https://github.com/micromark/micromark-extension-math)
- 実際のGitHubの動作

### 検証例

#### 例1: `$ x = 1 $`
- 開始`$`: can_open = false（直後が空白） → ❌

#### 例2: `$10 and $20`
- `$10`の`$`: can_open = true, can_close = false（直後が`1`）
- ` $20`の`$`: can_open = false（直後が空白）
- → ペア不成立 → ❌

#### 例3: `$100, but $x = 100$`
- `$100`の`$`: can_open = true, can_close = false（直後が`1`）
- ` $x`の`$`: can_open = true
- `100$`の`$`: can_close = true
- → 隣接ペア: `$x = 100$`のみ成立 → `$x = 100$`のみ✅

#### 例4: `$...$`
- ペア候補: `$...$`
- 内容: `...` → 英数字なし → ❌

#### 例5: `$x=1$`
- ペア候補: `$x=1$`
- 内容: `x=1` → 英数字あり → ✅

#### 例6: `$$...$$`
- 内容: `...` → 英数字なし → ❌
- 結果: そのまま`$$...$$`と表示される

#### 例7: `$$E=mc^2$$`
- 内容: `E=mc^2` → 英数字あり → ✅
- 結果: 数式としてレンダリングされる

#### 例8: `\[...\]`
- 内容: `...` → 英数字なし → ❌
- 結果: そのまま`\[...\]`と表示される

---

## パート4: テストパターンサマリー

### パート1の内容（約40パターン）
- 基本的な数式（リスト・段落）
- ディスプレイ数式
- LaTeX形式
- 数式と価格の混在（数式部分がレンダリング）
- 各コンテキストの数式（引用、テーブル、ネストリスト、番号付きリスト）

### パート2の内容（約105パターン）
- 価格表示（リスト・段落で約80ケース）
- コードブロック・インラインコード内
- スペースあり、エスケープ、HTMLタグ
- エッジケース（約30ケース）
- 見出し内（すべての数式記法）
- 各コンテキストの価格（引用、テーブル、ネストリスト、番号付きリスト）

**合計: 約145+パターン**

### 検証できる項目
1. ✅ 終了`$`の直後が英数字 → 価格表示
2. ✅ 内容に英数字が含まれない → 数式でない
3. ✅ 見出し内 → すべて無効
4. ✅ コードブロック/インラインコード → 保護
5. ✅ 隣接ペアリング → 正しく区別
6. ✅ リスト・段落・引用・テーブル → 同じ動作
