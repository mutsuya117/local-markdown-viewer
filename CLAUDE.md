# Local Markdown Viewer - プロジェクト設定

このファイルはClaude Codeがこのプロジェクトをサポートするためのプロジェクトレベル設定です。

## コミュニケーション言語

**重要**: このプロジェクトでは、すべてのコミュニケーションを**日本語**で行ってください。

- コード内のコメントは日本語で記述
- コミット メッセージは日本語で記述
- ドキュメントは日本語で記述
- ユーザーとの対話は日本語で実施

## プロジェクト概要

- **プロジェクト名**: Local Markdown Viewer
- **種類**: Chrome拡張機能
- **対象ユーザー**: 日本語ユーザー（日本語のみサポート）
- **目的**: ローカルのMarkdownファイル（.md, .markdown）をGitHubスタイルで美しくプレビュー表示する

## 技術スタック

### コア技術
- **言語**: バニラJavaScript（ES6+）
- **プラットフォーム**: Google Chrome拡張機能
- **Manifest Version**: 3（Manifest V3）

### 依存ライブラリ
- **marked.js** v12.0.0 - Markdownパーサー
- **highlight.js** v11.9.0 - シンタックスハイライト（140+言語対応）
- **DOMPurify** v3.0.8 - HTMLサニタイゼーション（XSS対策）
- **Mermaid** v11.4.1 - ダイアグラム描画ライブラリ
- **KaTeX** v0.16.10 - 数式レンダリングライブラリ

### ビルドツール
- **ビルドプロセス**: なし
- このプロジェクトはビルドステップを必要としません
- すべてのファイルは直接使用されます

## プロジェクト構造

```
C:\work\chrome_extention\local-markdown-viewer\
├── manifest.json          # Chrome拡張機能のマニフェストファイル（Manifest V3）
├── content.js            # メインのコンテンツスクリプト
├── README.md             # プロジェクトドキュメント（日本語）
├── icons/                # 拡張機能のアイコン（16, 32, 48, 128px）
├── libs/                 # サードパーティライブラリ
│   ├── marked.min.js
│   ├── highlight.min.js
│   ├── purify.min.js
│   ├── mermaid.min.js
│   ├── katex.min.js
│   ├── katex.min.css
│   ├── auto-render.min.js
│   └── highlight-github.min.css
├── styles/               # カスタムCSSスタイル
│   └── github.css        # GitHubスタイルのCSS
└── test/                 # テストディレクトリ
```

## 開発ガイドライン

### コーディングスタイル

1. **JavaScript**
   - バニラJavaScriptを使用（フレームワーク不使用）
   - ES6+の機能を積極的に使用（const/let, アロー関数, テンプレートリテラルなど）
   - セミコロンを使用
   - インデント: スペース2つ

2. **コメント**
   - すべてのコメントは日本語で記述
   - 複雑なロジックには必ず説明コメントを追加
   - JSDocスタイルは不要（シンプルなプロジェクトのため）

3. **命名規則**
   - 変数・関数: キャメルケース（例: `generateTableOfContents`）
   - 定数: UPPER_SNAKE_CASE（例: `MAX_HEADING_LEVEL`）
   - プライベート関数: アンダースコアプレフィックス（例: `_parseMarkdown`）

### Chrome拡張機能の制約

1. **Manifest V3の要件**
   - Content Security Policy (CSP)に準拠
   - `eval()`や動的コード実行は使用不可
   - インラインスクリプトは使用不可

2. **ファイルアクセス**
   - `file://` プロトコルでのアクセスをサポート
   - ユーザーは「ファイルのURLへのアクセスを許可する」を有効化する必要がある

3. **コンテンツスクリプトの制限**
   - ページのDOMにのみアクセス可能
   - Chrome APIへのアクセスは限定的

## 開発・テスト手順

### ローカルでの拡張機能の読み込み

1. `chrome://extensions/` を開く
2. 右上の「デベロッパーモード」をONにする
3. 「パッケージ化されていない拡張機能を読み込む」をクリック
4. このプロジェクトのルートディレクトリを選択
5. 「ファイルのURLへのアクセスを許可する」をONにする

### テスト方法

1. ローカルの.mdファイルをChromeで開く
2. DevToolsを開いてコンソールでエラーを確認
3. ページを再読み込み（Ctrl+R）して変更を確認

### デバッグ

- コンテンツスクリプトのデバッグ: ページ上でDevToolsを開く
- バックグラウンドスクリプトのデバッグ: `chrome://extensions/` の「バックグラウンドページ」リンクをクリック
- `console.log()` を使用してデバッグ情報を出力

## 機能概要

### 主要機能

1. **Markdown レンダリング**
   - GitHub Flavored Markdown (GFM) 完全対応
   - テーブル、タスクリスト、打ち消し線、自動リンク

2. **シンタックスハイライト**
   - 140+のプログラミング言語に対応
   - GitHubスタイルのカラースキーム

3. **Mermaidダイアグラム**
   - フローチャート、シーケンス図、クラス図、状態遷移図
   - ガントチャート、円グラフ、ER図など
   - ライト/ダークモード自動切り替え

4. **数式レンダリング（KaTeX）**
   - LaTeX形式の数式をサポート
   - インライン数式（$...$、\(...\)）
   - ディスプレイ数式（$$...$$、\[...\]）
   - ライト/ダークモード対応
   - ON/OFF切り替えボタン（右上に配置）
   - デフォルトON、localStorageに設定を保存

5. **自動目次（TOC）生成**
   - h1-h6の見出しから自動生成
   - レスポンシブ対応の左サイドバー
   - クリックでスムーズスクロール
   - サイドバー幅のリサイズ機能

6. **ダークモード**
   - ワンクリックでライト/ダークモードを切り替え
   - GitHub風のダークテーマ
   - localStorageに設定を保存

7. **印刷機能**
   - 右上に印刷ボタン（🖨️）を配置
   - ワンクリックで印刷ダイアログを開く
   - 印刷時は目次とボタンを自動的に非表示
   - メインコンテンツをフル幅で印刷
   - 現在のモード（ライト/ダーク）をそのまま維持
   - ページ区切りの最適化（見出しやコードブロックの途中で改ページしない）

8. **UIボタン**
   - すべてのボタンを40px × 40pxの円形に統一
   - 印刷ボタン（🖨️）: 左端
   - TeXボタン（2行表示）: 中央
   - ダークモード切り替えボタン（🌙/☀️）: 右端
   - ホバー時にスケール拡大アニメーション

9. **セキュリティ**
   - DOMPurifyによるHTMLサニタイゼーション
   - XSS攻撃の防止
   - Mermaid strictモードでスクリプト実行を防止
   - KaTeX trustモードを無効化（セキュリティ強化）
   - 数式ブロックをテキストノードとして安全に処理

## セキュリティ考慮事項

### 基本方針
- ユーザーが提供するMarkdownコンテンツは信頼できないものとして扱う
- HTMLレンダリング前に必ずDOMPurifyでサニタイズ
- 外部リソースの読み込みに注意
- `target="_blank"` を使用する際は `rel="noopener noreferrer"` を追加

### KaTeX数式のセキュリティ処理
1. **数式ブロックの保護**: Marked.jsパース前にプレースホルダーに置換
2. **DOMPurifyサニタイズ**: 通常のMarkdownをサニタイズ
3. **安全な復元**: プレースホルダーをテキストノードのnodeValueとして設定（HTMLとして解釈されない）
4. **KaTeX処理**: KaTeXライブラリが安全に数式をレンダリング

この手順により、数式ブロック内にスクリプトタグやXSSペイロードが含まれていても、実行されることはありません。

## ライセンス

- このプロジェクト: MIT License
- 使用ライブラリのライセンスは `THIRD_PARTY_LICENSES.md` を参照

## よくある作業

### ライブラリの更新

```bash
# libs/ディレクトリ内のファイルを手動で置き換える
# npm/yarnは使用していないため、公式サイトからダウンロード
```

### アイコンの変更

```bash
# icons/ディレクトリ内のPNGファイルを置き換える
# サイズ: 16x16, 32x32, 48x48, 128x128
```

### マニフェストの更新

```bash
# manifest.jsonを編集後、chrome://extensions/ で拡張機能を再読み込み
```

## 注意事項

- この拡張機能は日本語ユーザー向けであり、UI・ドキュメントは日本語のみ
- package.jsonは存在しない（npmプロジェクトではない）
- ビルドやトランスパイルのプロセスはない
- 全てのファイルはそのまま使用される
